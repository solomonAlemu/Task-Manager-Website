{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>Task Charts</h2>
    <div>
        <h3>Priority vs. Progress</h3>
        <canvas id="priorityChart" width="75" height="25"></canvas>
    </div>
    <div>
        <h3>Due Date Progress</h3>
        <div id="progressBars"></div>
    </div>
</div>

<script>
    // Fetch task data
    fetch('/task-data')
        .then(response => response.json())
        .then(data => {
            // Priority vs. Progress Chart
            const ctxPriority = document.getElementById('priorityChart').getContext('2d');
            new Chart(ctxPriority, {
                type: 'bar',
                data: {
                    labels: data.tasks.map(task => task.name),
                    datasets: [{
                        label: 'Task Progress (%)',
                        data: data.tasks.map(task => task.progress),
                        backgroundColor: data.tasks.map(task => {
                            if (task.priority === 'High') return 'rgba(255, 99, 132, 0.8)'; // Red
                            if (task.priority === 'Medium') return 'rgba(255, 205, 86, 0.8)'; // Yellow
                            return 'rgba(75, 192, 192, 0.8)'; // Green
                        }),
                        borderColor: data.tasks.map(task => {
                            if (task.priority === 'High') return 'rgba(255, 99, 132, 1)';
                            if (task.priority === 'Medium') return 'rgba(255, 205, 86, 1)';
                            return 'rgba(75, 192, 192, 1)';
                        }),
                        borderWidth: 1,
                        hoverBackgroundColor: data.tasks.map(task => {
                            if (task.priority === 'High') return 'rgba(255, 99, 132, 0.9)';
                            if (task.priority === 'Medium') return 'rgba(255, 205, 86, 0.9)';
                            return 'rgba(75, 192, 192, 0.9)';
                        })
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Task Priority and Progress Overview',
                            font: {
                                size: 18, // Increased title font size
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            bodyFont: {
                                size: 14 // Increased tooltip font size
                            },
                            callbacks: {
                                label: function(context) {
                                    const taskIndex = context.dataIndex;
                                    const task = data.tasks[taskIndex];
                                    return `${task.name}: ${task.progress}% (Priority: ${task.priority})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: {
                                    size: 14 // Increased font size for x-axis labels
                                }
                            },
                            title: {
                                display: true,
                                text: 'Tasks',
                                font: {
                                    size: 16 // Increased font size for x-axis title
                                }
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    size: 14 // Increased font size for y-axis labels
                                }
                            },
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Progress (%)',
                                font: {
                                    size: 16 // Increased font size for y-axis title
                                }
                            }
                        }
                    }
                }
            });

            // Enhanced Due Date Progress Bars
            const progressBars = document.getElementById('progressBars');
            data.tasks
                .sort((a, b) => new Date(a.due_date) - new Date(b.due_date)) // Sort by due date
                .forEach(task => {
                    const barContainer = document.createElement('div');
                    barContainer.style.margin = '15px 0';
                    barContainer.style.display = 'flex';
                    barContainer.style.alignItems = 'center';

                    const label = document.createElement('div');
                    label.style.width = '30%';
                    label.style.fontWeight = 'bold';
                    label.innerHTML = `
                        <span>${task.name}</span><br>
                        <small style="color: #666;">${task.due_date || 'No Due Date'}</small>
                    `;
                    barContainer.appendChild(label);

                    const progressBar = document.createElement('div');
                    progressBar.style.width = '70%';
                    progressBar.style.backgroundColor = '#eee';
                    progressBar.style.borderRadius = '5px';
                    progressBar.style.position = 'relative';
                    progressBar.style.height = '20px'; /* Reduced height for a slimmer look */

                    const progress = document.createElement('div');
                    progress.style.width = `${task.progress}%`;
                    progress.style.height = '100%';
					let color;
					if (task.progress > 90) {
					    color = 'linear-gradient(to right, #228B22, #006400)'; // Dark Green to Green
					} else if (task.progress > 75) {
					    color = 'linear-gradient(to right, #228B22, #32CD32)'; // Light Green to Green
					} else if (task.progress > 60) {
					    color = 'linear-gradient(to right, #ADFF2F, #32CD32)'; // Yellow Green to Light Green
					} else if (task.progress > 45) {
					    color = 'linear-gradient(to right, #FFFF00, #ADFF2F)'; // Yellow to Yellow Green
					} else if (task.progress > 30) {
					    color = 'linear-gradient(to right, #FFA500, #FFFF00)'; // Orange to Yellow
					} else {
					    color = 'linear-gradient(to right, #FF0000,  #FFFF00)'; // Red to Orange
					}
					progress.style.background = color;


                    progress.style.borderRadius = '5px';
                    progress.style.transition = 'width 0.5s ease-in-out';

                    const progressText = document.createElement('span');
                    progressText.textContent = `${task.progress}%`;
                    progressText.style.position = 'absolute';
                    progressText.style.right = '5px';
                    progressText.style.top = '50%';
                    progressText.style.transform = 'translateY(-50%)';
                    progressText.style.color = 'white';
                    progressText.style.fontWeight = 'bold';

                    progressBar.appendChild(progress);
                    progressBar.appendChild(progressText);
                    barContainer.appendChild(progressBar);

                    progressBars.appendChild(barContainer);
                });
        })
        .catch(error => {
            console.error('Error fetching task data:', error);
            const progressBars = document.getElementById('progressBars');
            progressBars.innerHTML = `<p style="color: red;">Failed to load task data: ${error.message}</p>`;
        });
</script>
{% endblock %}

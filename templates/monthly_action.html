{% extends 'base.html' %}

{% block content %}
<div class="container">
    <!-- Add Action Button -->
    <section>
        <h2>Manage Monthly Actions</h2>
        <button id="showFormButton" type="button" class="show-btn">Add Action</button>
    </section>

    <!-- Monthly Action Item Creation Form (Initially Hidden) -->
    <section id="taskFormSection" style="display: none;">
        <h2>Create Monthly Action Item</h2>
        <form id="addTaskForm" action="{{ url_for('monthly_action') }}" method="post">
            <div class="form-group">
                <label for="description">Description</label>
                <input type="text" name="description" id="description" required>
            </div>
            <div class="form-group">
                <label for="priority">Priority</label>
                <select name="priority" id="priority">
                    <option value="High">High</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            <div class="form-group">
                <label for="due_date">Due Date</label>
                <input type="date" name="due_date" id="due_date">
            </div>
            <div class="form-group">
                <label for="notes">Notes</label>
                <textarea name="notes" id="notes"></textarea>
            </div>
			<button type="submit" onclick="return confirm('Are you sure you want to add this item?')">Add Monthly Action Item</button>
        </form>
    </section>

	<section>
	    <h3>Fetch Historical Monthly Action Items</h3>
	    <form id="fetchForm" class="fetch-form">
	        <select name="status" id="status">
	            <option value="">All</option>
	            <option value="Open">Open</option>
	            <option value="In Progress">In Progress</option>
	            <option value="Completed">Completed</option>
	            <option value="Cancelled">Cancelled</option>
	        </select>
	        <input type="text" id="keyword" name="keyword" placeholder="Search keyword">
	        <button type="button" id="fetchButton">Fetch Items</button>
	    </form>
	    <div id="actionResults"></div> <!-- Container to display fetched action results -->
	</section>


    <section>
        <h2>Current Monthly Action Items</h2>
        {% if monthly_actions %}
        <table class="action-list">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Description</th>
                    <th>Priority</th>
                    <th>Due Date</th>
                    <th>Status</th>
                    <th>Completion (%)</th>
                    <th>Actions</th>
                    <th>Updates</th>
                </tr>
            </thead>
            <tbody>
                {% for action in monthly_actions %}
                 
                <tr>
                    <td>{{ action[0] }}</td>
                    <td>{{ action[1] }}</td>
                    <td>{{ action[2] }}</td>
                    <td>{{ action[4] or 'N/A' }}</td>
                    <td>{{ action[3] }}</td>
                    <td>{{ action[5] }}%</td>
                    <td>
                        <form action="{{ url_for('update_monthly_action', action_id=action[0]) }}" method="post">
                            <select name="status">
                                <option value="Open" {% if action[3] == 'Open' %}selected{% endif %}>Open</option>
                                <option value="In Progress" {% if action[3] == 'Completed' %}selected{% endif %}>In Progress</option>
								<option value="Completed" {% if action[3] == 'Completed' %}selected{% endif %}>Completed</option>
                                <option value="Cancelled" {% if action[3] == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                            <input type="number" name="percentage_completion" value="{{ action[5] }}" min="0" max="100">
                            <textarea name="notes">{{ action[6] or '' }}</textarea>
                            <button type="submit"class="status-btn">Update</button> 
                        </form>
                        <form action="{{ url_for('delete_monthly_action', action_id=action[0]) }}" method="post">
                            <button type="submit" class="delete-btn" onclick="return confirm('Are you sure you want to delete this item?')">Delete</button>
                        </form>
                    </td>
                    <td class="updates" >{{ action[6] }}</td>
                </tr>
                 
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No monthly action items found.</p>
        {% endif %}
    </section>
    
    <script>
		// Fetch Monthly Action Items Dynamically
		document.getElementById('fetchButton').addEventListener('click', function () {
		    const status = document.getElementById('status').value;
		    const keyword = document.getElementById('keyword').value;

		    const params = new URLSearchParams();
		    if (status) params.append('status', status);
		    if (keyword) params.append('keyword', keyword);

		    fetch(`/fetch_monthly_actions?${params.toString()}`)
		        .then(response => response.json())
		        .then(data => {
		            const actionResults = document.getElementById('actionResults');
		            actionResults.innerHTML = ''; // Clear previous results

		            if (data.success) {
		                if (data.monthly_actions.length === 0) {
		                    actionResults.innerHTML = '<p>No action items found.</p>';
		                } else {
		                    const table = document.createElement('table');
		                    table.className = 'fetch-list';
		                    const thead = `
		                        <thead>
		                            <tr>
		                                <th>ID</th>
		                                <th>Description</th>
		                                <th>Status</th>
		                                <th>Due Date</th>
		                                <th>Completion (%)</th>
		                                <th>Notes</th>
		                            </tr>
		                        </thead>`;
		                    table.innerHTML = thead;

		                    const tbody = document.createElement('tbody');
		                    data.monthly_actions.forEach(action => {
		                        const row = `
		                            <tr>
		                                <td>${action.id}</td>
		                                <td>${action.description}</td>
		                                <td>${action.status}</td>
		                                <td>${action.due_date || 'N/A'}</td>
		                                <td>${action.percentage_completion}%</td>
		                                <td>${action.notes || ''}</td>
		                            </tr>`;
		                        tbody.innerHTML += row;
		                    });
		                    table.appendChild(tbody);
		                    actionResults.appendChild(table);
		                }
		            } else {
		                actionResults.innerHTML = `<p>Error: ${data.error}</p>`;
		            }
		        })
		        .catch(error => {
		            console.error('Error fetching action items:', error);
		        });
		});

		function displayTextWithNewLines(text, elementId) {
			    // Replace newline characters with <br> tags
			    const formattedText = text.replace(/\n/g, '<br>');
			    // Insert the formatted text into the specified element
			    document.getElementById(elementId).innerHTML = formattedText;
			}

			document.addEventListener('DOMContentLoaded', () => {
				    document.querySelectorAll('.updates').forEach((cell, index) => {
				        // Assign a unique ID to each cell if it doesn't have one
				        if (!cell.id) {
				            cell.id = `updateCell_${index}`;
				        }
				        // Display text with new lines in each cell
				        displayTextWithNewLines(cell.textContent, cell.id);
				    });
				});  

    // Show the form when the "Add Action" button is clicked
    document.getElementById("showFormButton").addEventListener("click", function () {
        const formSection = document.getElementById("taskFormSection");
        formSection.style.display = "block"; // Show the form section
        this.style.display = "none"; // Hide the "Add Action" button
    });
 
    </script>
</div>
{% endblock %}

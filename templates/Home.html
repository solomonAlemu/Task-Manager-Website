{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Email Management Section -->
    <section class="email-management">
        <h2>Email Recipient Management</h2>
        <div class="email-form">
            <div class="form-group">
                <label for="emailName">Name:</label>
                <input type="text" id="emailName" placeholder="Enter recipient name" required>
            </div>
            <div class="form-group">
                <label for="emailAddress">Email Address:</label>
                <input type="email" id="emailAddress" placeholder="Enter email address" required>
            </div>
            <button onclick="manageEmails()" class="btn-primary">Add Email Recipient</button>
        </div>
    </section>

    <!-- Add Action Button -->
    <section class="task-actions">
        <h2>Manage Daily Actions</h2>
        <h3>Add New Tasks</h3>
	<button id="showFormButton" type="button" class="show-btn">Add Task</button>

    </section>

    <!-- Task Creation Form (Initially Hidden) -->
    <section id="taskFormSection" style="display: none;">
        <h2>Create a Task</h2>
        <form id="addTaskForm" action="{{ url_for('add_task') }}" method="post">
            <div class="form-group">
                <label for="description">Description</label>
                <input type="text" name="description" required>
            </div>
            <div class="form-group">
                <label for="priority">Priority</label>
                <select name="priority">
                    <option value="High">High Priority</option>
                    <option value="Medium" selected>Medium Priority</option>
                    <option value="Low">Low Priority</option>
                </select>
            </div>
            <div class="form-group">
                <label for="monthly_action_id">Monthly Action Item (Optional)</label>
                <select name="monthly_action_id">
                    <option value="">Select Monthly Action Item</option>
                    {% for action in monthly_actions %}
                    <option value="{{ action[0] }}">{{ action[1] }} ({{ action[2] }} Priority)</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="assigned_person">Assigned Person</label>
                <input type="text" name="assigned_person">
            </div>
            <div class="form-group">
                <label for="due_date">Due Date</label>
                <input type="date" name="due_date">
            </div>
            <button type="submit" id="addTaskButton" class="btn-addTask">Add Task</button>
        </form>
    </section>

    <!-- Search Form for Fetching Tasks -->
    <section class="task-search">
        <h3>Fetch Historical Tasks</h3>
        <form id="fetchForm" class="add-task-form">
            <select name="status" id="status">
                <option value="">All</option>
                <option value="Open">Open</option>
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
            </select>
            <input type="text" id="keyword" name="keyword" placeholder="Search keyword">
            <button type="button" id="fetchButton" class="btn btn-fetch">Fetch Tasks</button>
        </form>
        <div id="taskResults"></div>
    </section>

    <!-- Daily Task List -->
    <section class="task-list">
        <h2>Daily Task List</h2>
        {% if tasks %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Assigned Person</th>
                    <th>Description</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Monthly Action</th>
                    <th>Due Date</th>
                    <th>Status (%)</th>   
                    <th>Actions</th>
                    <th>Updates</th>
                    <th>Email Notification</th>
                </tr>
            </thead>
            <tbody>
                {% for task in tasks %}
                <tr>
                    <td>{{ task[0] }}</td>
                    <td>{{ task[1] or "Not Assigned" }}</td>
                    <td>{{ task[2] }}</td>
                    <td>{{ task[3] }}</td>
                    <td>{{ task[4] }}</td>
                    <td>{{ task[9] if task[9] else 'No linked action' }}</td>
                    <td>{{ task[8] }}</td>
                    <td>{{ task[5] }} %</td>
		<td>
		<!-- Update Task Progress -->
		<form action="{{ url_for('update_task', task_id=task[0]) }}" method="POST" class="form-container">
		<div class="grid-container">
		    <div class="grid-item">
			<label for="progress">Progress (%)</label>
			<input
			    type="number"
			    id="progress"
			    name="percentage_completion"
			    min="0"
			    max="100"
			    value="{{ task[5] }}"
			    required
			/>
		    </div>
		    <div class="grid-item">
			<label for="status">Task Status</label>
			<select name="status" id="status">
			    <option value="Open" {% if task[2] == 'Open' %}selected{% endif %}>Open</option>
			    <option value="In Progress" {% if task[2] == 'In Progress' %}selected{% endif %}>In Progress</option>
			    <option value="Completed" {% if task[2] == 'Completed' %}selected{% endif %}>Completed</option>
			    <option value="Cancelled" {% if task[2] == 'Cancelled' %}selected{% endif %}>Cancelled</option>
			</select>
		    </div>
		    <div class="grid-item">
			<label for="notes">Notes</label>
			<textarea
			    name="notes"
			    class="notes-text"
			    placeholder="Add notes..."
			></textarea>
		    </div>
		<div class="form-group">
		    <label for="assigned_person">Assigned Person</label>
		    <input type="text" name="assigned_person" value="{{ task[1] }}">
		</div>
		    <div class="grid-item">
			<button type="submit" class="status-btn"onclick="return confirm('Are you sure you want to update this item?')">Update</button>
		    </div>
		</div>
		</form>

		<!-- Delete Task -->
		<form action="/delete/{{ task[0] }}" method="POST" class="delete-form">
		<button
		    type="submit"
		    class="delete-btn"
		    onclick="return confirm('Are you sure you want to delete this item?')"
		>
		    Delete
		</button>
		</form>
                </td>

		    <td class="updates" >{{ task[7] }}</tdclass="email-recipient-list form-control">
                    <!-- Email Notification Column -->
					<td>
						<select id="emailSelect_{{ task[0] }}" class="email-recipient-list form-control" multiple>
					        <option value="">Select Recipient</option>
					    </select>
						<select id="emailIntent_{{ task[0] }}" class="email-intent-list form-control">
						    <option value="Assignment">Assignment</option>
						    <option value="Status request">Status request</option>
						    <option value="Reminder">Reminder</option>
						    <option value="Notification" selected>Notification</option>
						</select>

					    <button 
					        onclick="sendTaskEmail({{ task[0] }})" 
					        class="btn-sendTaskEmail"
					    >
					        Send
					    </button>
					</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No tasks to display</p>
        {% endif %}
    </section>
	<script>
	// Fetch Tasks Dynamically
	document.getElementById('fetchButton').addEventListener('click', function () {
	    const status = document.getElementById('status').value;
	    const keyword = document.getElementById('keyword').value;

	    const params = new URLSearchParams();
	    if (status) params.append('status', status);
	    if (keyword) params.append('keyword', keyword);

	    fetch(`/fetch?${params.toString()}`)
	        .then(response => response.json())
	        .then(data => {
	            const taskResults = document.getElementById('taskResults');
	            taskResults.innerHTML = ''; // Clear previous results

	            if (data.success) {
	                if (data.tasks.length === 0) {
	                    taskResults.innerHTML = '<p>No tasks found.</p>';
	                } else {
	                    const table = document.createElement('table');
	                    table.className = 'history-list';
	                    const thead = `
						    
	                        <thead>  
								<tr>
								    <th colspan="6"><h2>Historical Tasks</h2></th>
								</tr>							
	                            <tr>
	                                <th>ID</th>
									<th>Assigned Person</th>
	                                <th>Description</th>
	                                <th>Status</th>
	                                <th>Updates</th>
	                                <th>Created At</th>
	                            </tr>
	                        </thead>`;
	                    table.innerHTML = thead;

	                    const tbody = document.createElement('tbody');
	                    data.tasks.forEach(task => {
	                        const row = `

	                            <tr>
	                                <td>${task.id}</td>
									<td>${task.assigned_person}</td>
	                                <td>${task.description}</td>
	                                <td>${task.status}</td>
	                                <td>${task.notes || ''}</td>
	                                <td>${task.created_at}</td>
	                            </tr>`;
	                        tbody.innerHTML += row;
	                    });
	                    table.appendChild(tbody);
	                    taskResults.appendChild(table);
	                }
	            } else {
	                taskResults.innerHTML = `<p>Error: ${data.error}</p>`;
	            }
	        })
	        .catch(error => {
	            console.error('Error fetching tasks:', error);
	        });
	});
	document.querySelectorAll(".notes-text").forEach(textarea => {
	  textarea.addEventListener('change', function() {
	    const taskId = this.closest('tr').querySelector("td:first-child").textContent;
	    const noteContent = this.value;

	    fetch(`/update-note/${taskId}`, {
	      method: 'POST',
	      headers: { 'Content-Type': 'application/json' },
	      body: JSON.stringify({ notes: noteContent })
	    })
	    .then(response => response.json())
	    .then(data => {
	      if(data.success) {
	        console.log('Notes updated');
	      } else {
	        alert('Failed to update notes');
	      }
	    });
	  });
	});
    // Show the form when the "Add Action" button is clicked
    document.getElementById("showFormButton").addEventListener("click", function () {
        const formSection = document.getElementById("taskFormSection");
        formSection.style.display = "block"; // Show the form section
        this.style.display = "none"; // Hide the "Add Action" button
    });

    // Email Management Functions
    function manageEmails() {
        const name = document.getElementById('emailName').value;
        const email = document.getElementById('emailAddress').value;

        if (!name || !email) {
            alert('Please enter both name and email');
            return;
        }

        fetch('/manage-emails', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}`
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) {
                document.getElementById('emailName').value = '';
                document.getElementById('emailAddress').value = '';
                populateEmailList();
            }
        })
		.catch(error => {
		    console.error('Error sending email:', error);
		    alert(`An error occurred while sending the email: ${error.message}`);
		});

    }

	function sendTaskEmail(taskId) {
	    const emailSelect = document.getElementById(`emailSelect_${taskId}`);
	    const intentSelect = document.getElementById(`emailIntent_${taskId}`);
	    const selectedOptions = Array.from(emailSelect.selectedOptions);
	    const recipients = selectedOptions.map(option => {
	        const [name, email] = option.text.split(' (');
	        return { name: name.trim(), email: email.replace(')', '').trim() };
	    });
	    const emailIntent = intentSelect.value;

	    if (recipients.length === 0) {
	        alert('Please select at least one email recipient');
	        return;
	    }

	    fetch('/send-task-email', {
	        method: 'POST',
	        headers: {
	            'Content-Type': 'application/x-www-form-urlencoded',
	        },
	        body: `task_id=${taskId}&recipients=${encodeURIComponent(JSON.stringify(recipients))}&intent=${encodeURIComponent(emailIntent)}`
	    })
	    .then(response => response.json())
	    .then(data => {
	        alert(data.message);
	    })
	    .catch(error => {
	        console.error('Error sending email:', error);
	        alert('An error occurred while sending the email');
	    });
	}




    // Populate Email Recipient Lists
    function populateEmailList() {
        fetch('/manage-emails')
        .then(response => response.json())
        .then(data => {
            const emailLists = document.querySelectorAll('.email-recipient-list');
            emailLists.forEach(list => {
                list.innerHTML = '<option value="">Select Recipient</option>';
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.email;
                    option.textContent = `${user.name} (${user.email})`;
                    list.appendChild(option);
                });
            });
        })
        .catch(error => {
            console.error('Error fetching emails:', error);
        });
    }

	function populateEmailDropdown(taskId) {
	    fetch('/get-emails')
	        .then(response => response.json())
	        .then(data => {
	            const emailSelect = document.getElementById(`emailSelect_${taskId}`);
	            emailSelect.innerHTML = '<option value="">Select Recipient</option>'; // Clear existing options
	            data.forEach(user => {
	                const option = document.createElement('option');
	                option.value = user.email;
	                option.textContent = `${user.name} (${user.email})`;
	                emailSelect.appendChild(option);
	            });
	        })
	        .catch(error => {
	            console.error('Error fetching emails:', error);
	        });
	}

	function displayTextWithNewLines(text, elementId) {
	    // Replace newline characters with <br> tags
	    const formattedText = text.replace(/\n/g, '<br>');
	    // Insert the formatted text into the specified element
	    document.getElementById(elementId).innerHTML = formattedText;
	}

	// Example text for demonstration
	const exampleText = "This is an example text\nthat includes new line characters\nand it should display accordingly.";

	// Call this function for each task after the DOM is loaded
	document.addEventListener('DOMContentLoaded', () => {
	    document.querySelectorAll('.updates').forEach((cell, index) => {
	        // Assign a unique ID to each cell if it doesn't have one
	        if (!cell.id) {
	            cell.id = `updateCell_${index}`;
	        }
	        // Display text with new lines in each cell
	        displayTextWithNewLines(cell.textContent, cell.id);
	    });
	    document.querySelectorAll('.email-recipient-list').forEach(select => {
	        const taskId = select.id.split('_')[1];
	        populateEmailDropdown(taskId);
	    });
	});



    // Optional: Alert the form action on form submission
    document.getElementById("addTaskForm").addEventListener("submit", function (event) {
        event.preventDefault(); // Prevent immediate form submission
        const formAction = this.action; // Get the form's action URL
        alert(`Form Action URL: ${formAction}`); // Display the action URL
        this.submit(); // Submit the form
    });
	

		
    </script>
</div>
{% endblock %}
